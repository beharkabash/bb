# 🚀 Kroi Auto Center - Render Deployment Guide

This guide walks you through deploying Kroi Auto Center to Render with all features enabled.

## 📋 Prerequisites

Before deploying, ensure you have:

- [ ] Render account (free tier available)
- [ ] GitHub repository with your code
- [ ] Domain name (optional, Render provides free subdomain)
- [ ] Email service (Gmail/SMTP)
- [ ] Basic understanding of environment variables

## 🏗️ Architecture Overview

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Web Service   │    │   PostgreSQL     │    │      Redis      │
│  (Next.js App)  │◄──►│   Database       │    │     Cache       │
│                 │    │                  │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Features                                  │
├─────────────────┬─────────────────┬─────────────────┬─────────────┤
│ 🚗 Car Listings │ 📧 Email Alerts│ 💬 WhatsApp    │ 📊 Analytics│
│ 🔍 Search & SEO │ 🛒 Comparison  │ 📱 PWA         │ 🔒 Security  │
│ 💰 Financing    │ 📈 Monitoring  │ 🌐 Multi-lang  │ 🎨 Optimized│
└─────────────────┴─────────────────┴─────────────────┴─────────────┘
```

## 🗺️ Deployment Steps

### Step 1: Create Render Services

#### 1.1 Web Service

1. **Go to Render Dashboard**
   ```
   https://dashboard.render.com
   ```

2. **Create New Web Service**
   - Click "New +"
   - Select "Web Service"
   - Connect your GitHub repository
   - Select the branch (usually `main`)

3. **Configure Build Settings**
   ```yaml
   Name: kroi-auto-center
   Environment: Node
   Region: Frankfurt (closest to Finland)
   Branch: main
   Build Command: npm ci && npm run build
   Start Command: npm start
   ```

#### 1.2 PostgreSQL Database

1. **Create Database**
   - Click "New +"
   - Select "PostgreSQL"
   - Name: `kroi-auto-db`
   - Plan: Starter (Free)
   - Region: Frankfurt

2. **Note Database Info**
   - Database URL will be auto-generated
   - Available as `DATABASE_URL` environment variable

#### 1.3 Redis Cache

1. **Create Redis Service**
   - Click "New +"
   - Select "Redis"
   - Name: `kroi-redis`
   - Plan: Starter (Free)
   - Region: Frankfurt

2. **Note Redis Info**
   - Connection URL will be auto-generated
   - Available as `REDIS_URL` environment variable

### Step 2: Environment Variables

#### 2.1 Copy Environment Template

1. **Open the template file**: `.env.render.template`
2. **Go to your Web Service** → Settings → Environment
3. **Add environment variables** one by one

#### 2.2 Required Variables (Minimum for basic functionality)

```env
# Core (Auto-generated by Render)
NODE_ENV=production
DATABASE_URL=${DATABASE_URL}
REDIS_URL=${REDIS_URL}

# Security (Use Render's "Generate" button)
NEXTAUTH_SECRET=[GENERATE-RANDOM]
JWT_SECRET=[GENERATE-RANDOM]
WEBHOOK_SECRET=[GENERATE-RANDOM]

# Site Configuration
NEXT_PUBLIC_SITE_URL=https://kroi-auto-center.onrender.com
NEXTAUTH_URL=https://kroi-auto-center.onrender.com

# Business Contact
CONTACT_EMAIL=info@kroiautocenter.fi
CONTACT_PHONE=+358413188214
WHATSAPP_PHONE_NUMBER=+358413188214

# Email (Required for notifications)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM=noreply@kroiautocenter.fi
```

#### 2.3 Optional Variables (Enhanced functionality)

```env
# Analytics
NEXT_PUBLIC_GA_ID=G-XXXXXXXXXX
SENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id

# Features (Enable/Disable)
FEATURE_INVENTORY_ALERTS=true
FEATURE_CAR_COMPARISON=true
FEATURE_FINANCING_CALCULATOR=true
FEATURE_LIVE_CHAT=true
FEATURE_PWA=true

# Performance
REDIS_TTL_CARS=900
API_RATE_LIMIT_PER_MINUTE=60
```

### Step 3: Domain Configuration (Optional)

#### 3.1 Custom Domain Setup

1. **In Render Dashboard**
   - Go to your Web Service
   - Settings → Custom Domains
   - Add your domain: `kroiautocenter.fi`
   - Add www subdomain: `www.kroiautocenter.fi`

2. **DNS Configuration**
   ```dns
   # A Record
   kroiautocenter.fi → [Render IP]

   # CNAME Record
   www.kroiautocenter.fi → kroi-auto-center.onrender.com
   ```

3. **Update Environment Variables**
   ```env
   NEXT_PUBLIC_SITE_URL=https://kroiautocenter.fi
   NEXTAUTH_URL=https://kroiautocenter.fi
   ```

### Step 4: Database Setup

#### 4.1 Run Initial Migration

1. **Connect to Database** (via Render Shell or local connection)
2. **Apply Prisma migrations**:
   ```bash
   npx prisma migrate deploy
   npx prisma generate
   ```

3. **Run optimization script**:
   ```bash
   psql $DATABASE_URL -f scripts/optimize-database.sql
   ```

#### 4.2 Seed Initial Data (Optional)

```bash
npx prisma db seed
```

### Step 5: SSL & Security

#### 5.1 SSL Certificate
- Render automatically provides SSL certificates
- Force HTTPS redirects are enabled by default

#### 5.2 Security Headers
Environment variables handle security configuration:
```env
SECURITY_CONTENT_SECURITY_POLICY="default-src 'self'; script-src 'self' 'unsafe-inline'..."
CORS_ORIGINS=https://kroiautocenter.fi,https://www.kroiautocenter.fi
```

## 🔧 Configuration Guides

### Email Setup (Gmail SMTP)

1. **Enable 2-Factor Authentication** on your Gmail account
2. **Generate App Password**:
   - Google Account → Security → 2-Step Verification → App passwords
   - Select "Mail" and "Other" → Enter "Kroi Auto Center"
   - Copy the 16-character password

3. **Configure Environment Variables**:
   ```env
   SMTP_HOST=smtp.gmail.com
   SMTP_PORT=587
   SMTP_USER=your-email@gmail.com
   SMTP_PASS=abcd-efgh-ijkl-mnop  # 16-character app password
   SMTP_FROM=noreply@kroiautocenter.fi
   ```

### Google Analytics Setup

1. **Create GA4 Property**:
   - Go to https://analytics.google.com
   - Create new property for your domain
   - Get Measurement ID (format: G-XXXXXXXXXX)

2. **Add to Environment**:
   ```env
   NEXT_PUBLIC_GA_ID=G-XXXXXXXXXX
   ```

### Sentry Error Monitoring

1. **Create Sentry Project**:
   - Sign up at https://sentry.io
   - Create new Next.js project
   - Copy DSN from project settings

2. **Configure Environment**:
   ```env
   SENTRY_DSN=https://your-key@sentry.io/project-id
   SENTRY_TRACES_SAMPLE_RATE=0.1
   ```

## 📊 Monitoring & Maintenance

### Health Checks

The application includes built-in health monitoring:

```
GET /api/health
```

Response includes:
- Database connectivity
- Redis connectivity
- Memory usage
- System uptime

### Performance Monitoring

1. **Database Performance**:
   ```sql
   -- Check slow queries
   SELECT * FROM slow_queries;

   -- Check table statistics
   SELECT * FROM table_stats;
   ```

2. **Application Logs**:
   - Render Dashboard → Your Service → Logs
   - Filter by error level
   - Set up log alerts

### Backup Strategy

1. **Database Backups**:
   - Render PostgreSQL includes automatic daily backups
   - Manual backup: Use `pg_dump` via Render shell

2. **Code Backups**:
   - Git repository serves as code backup
   - Tag releases for easy rollback

## 🚀 Go Live Checklist

- [ ] All services deployed and running
- [ ] Environment variables configured
- [ ] Database migrations applied
- [ ] Custom domain configured (if applicable)
- [ ] SSL certificate active
- [ ] Health checks passing
- [ ] Email notifications working
- [ ] Analytics tracking
- [ ] Error monitoring setup
- [ ] Performance optimization applied
- [ ] Backup strategy confirmed

## 🆘 Troubleshooting

### Common Issues

1. **Build Failures**:
   ```bash
   # Check build logs in Render dashboard
   # Common fix: Clear build cache and redeploy
   ```

2. **Database Connection Issues**:
   ```bash
   # Verify DATABASE_URL format
   # Check database service status
   # Test connection via health endpoint
   ```

3. **Email Not Sending**:
   ```bash
   # Verify SMTP credentials
   # Check Gmail app password
   # Test with curl/Postman
   ```

4. **Redis Connection Issues**:
   ```bash
   # Verify REDIS_URL format
   # Check Redis service status
   # Features will work without Redis (degraded performance)
   ```

### Getting Help

1. **Render Support**: https://render.com/docs
2. **Application Logs**: Render Dashboard → Logs
3. **Health Check**: `https://your-app.onrender.com/api/health`
4. **GitHub Issues**: Create issue in repository

## 🎯 Post-Deployment

### Performance Optimization

1. **Monitor key metrics**:
   - Response times
   - Error rates
   - Database performance
   - Memory usage

2. **SEO Setup**:
   - Submit sitemap to Google Search Console
   - Verify structured data
   - Monitor Core Web Vitals

3. **User Analytics**:
   - Set up conversion tracking
   - Monitor user journeys
   - Analyze car listing performance

### Feature Enhancement

1. **Enable Progressive Features**:
   ```env
   EXPERIMENTAL_AI_CHAT=true
   EXPERIMENTAL_AR_PREVIEW=true
   ```

2. **A/B Testing**:
   - Test different layouts
   - Optimize conversion funnels
   - Analyze user preferences

---

## 🎉 Congratulations!

Your Kroi Auto Center application is now live on Render with:

- ✅ Production-grade database and caching
- ✅ Automated inventory alerts
- ✅ WhatsApp integration
- ✅ Car comparison tools
- ✅ PWA capabilities
- ✅ SEO optimization
- ✅ Performance monitoring
- ✅ Security hardening

Your customers can now browse your inventory, get financing estimates, compare cars, and receive notifications about new vehicles matching their criteria!

---

*For technical support or feature requests, please create an issue in the GitHub repository.*